{% load static %}
<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
  <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
    href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800" />
  <title>{{ san.name }} - Detail</title>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
</head>

<body class="bg-[#fbf9f9]" style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>

  <!-- HEADER -->
  <header class="flex items-center justify-between border-b border-[#f1e9ea] px-10 py-3">
    <div class="flex items-center gap-4 text-[#191010]">
      <div class="size-4">
        <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 4H17.3334V17.3334H30.6666V30.6666H44V44H4V4Z" fill="currentColor"></path>
        </svg>
      </div>
      <h2 class="text-lg font-bold">RaffleApp</h2>
    </div>
    <div class="flex gap-9">
      <a class="text-sm font-medium" href="{% url 'home' %}">Home</a>
      <a class="text-sm font-medium" href="{% url 'san_list' %}">Browse</a>
      <a class="text-sm font-medium" href="{% url 'create_san' %}">Create SAN</a>
    </div>
  </header>

  <!-- CONTENIDO -->
  <div class="px-40 flex flex-1 justify-center py-5">
    <div class="flex flex-col max-w-[960px] flex-1">

      <!-- TÍTULO -->
      <div class="flex justify-between p-4">
        <p class="text-[32px] font-bold">{{ san.name }}</p>
      </div>

      <!-- IMAGEN Y DESCRIPCIÓN -->
      <div class="flex p-4 gap-6">
        <div class="flex-1">
          {% if san.image %}
          <div class="w-full aspect-square bg-cover rounded-xl" style='background-image: url("{{ san.image.url }}");'>
          </div>
          {% else %}
          <div class="w-full aspect-square bg-[#f1e9ea] rounded-xl flex items-center justify-center text-[#8b5b5c]">
            No image available
          </div>
          {% endif %}
        </div>
        <div class="flex-1 flex flex-col">
          <p class="text-base">{{ san.description }}</p>
        </div>
      </div>

      <!-- DATOS DEL SAN -->
      <div class="p-4 grid grid-cols-[30%_1fr] gap-x-6">
        <div class="col-span-2 border-t border-[#e3d4d4] py-5 flex justify-between">
          <p class="text-sm text-[#8b5b5c]">Organizador</p>
          <p class="text-sm text-[#191010]">{{ san.organizador.get_full_name|default:san.organizador.username }}</p>
        </div>
        <div class="col-span-2 border-t border-[#e3d4d4] py-5 flex justify-between">
          <p class="text-sm text-[#8b5b5c]">Tipo de SAN</p>
          <p class="text-sm text-[#191010]">{{ san.get_type_of_san_display }}</p>
        </div>
        <div class="col-span-2 border-t border-[#e3d4d4] py-5 flex justify-between">
          <p class="text-sm text-[#8b5b5c]">Frecuencia de Pago</p>
          <p class="text-sm text-[#191010]">{{ san.get_payment_frequency_display }}</p>
        </div>
        <div class="col-span-2 border-t border-[#e3d4d4] py-5 flex justify-between">
          <p class="text-sm text-[#8b5b5c]">Precio Total</p>
          <p class="text-sm text-[#191010]">${{ san.total_price|floatformat:2 }}</p>
        </div>
        <div class="col-span-2 border-t border-[#e3d4d4] py-5 flex justify-between">
          <p class="text-sm text-[#8b5b5c]">Cupos Totales</p>
          <p class="text-sm text-[#191010]">{{ san.total_participantes }}</p>
        </div>
        <div class="col-span-2 border-t border-[#e3d4d4] py-5 flex justify-between">
          <p class="text-sm text-[#8b5b5c]">Cupos Disponibles</p>
          <p class="text-sm text-[#191010]">{{ san.cupos_disponibles }}</p>
        </div>
        <div class="col-span-2 border-t border-[#e3d4d4] py-5 flex justify-between">
          <p class="text-sm text-[#8b5b5c]">Fecha de Inicio</p>
          <p class="text-sm text-[#191010]">{{ san.fecha_inicio|date:"F d, Y" }}</p>
        </div>
        <div class="col-span-2 border-t border-[#e3d4d4] py-5 flex justify-between">
          <p class="text-sm text-[#8b5b5c]">Fecha Estimada de Fin</p>
          <p class="text-sm text-[#191010]">{{ san.fecha_fin|date:"F d, Y" }}</p>
        </div>
      </div>

      <!-- PARTICIPANTES -->
      <h2 class="text-[22px] font-bold px-4 pb-3 pt-5">Participantes</h2>
      <div class="px-4 py-3">
        <div class="overflow-hidden rounded-xl border border-[#e3d4d4]">
          <table class="w-full">
            <thead>
              <tr class="bg-[#fbf9f9]">
                <th class="px-4 py-3 text-left text-sm font-medium">Nombre</th>
                <th class="px-4 py-3 text-left text-sm font-medium">Estado de Pago</th>
                <th class="px-4 py-3 text-left text-sm font-medium">Fecha de Desembolso</th>
              </tr>
            </thead>
            <tbody>
              {% for participante in participantes %}
              <tr class="border-t border-[#e3d4d4]">
                <td class="px-4 py-2 text-sm">
                  {{ participante.usuario.get_full_name|default:participante.usuario.username }}
                </td>
                <span
                  class="inline-block px-4 py-1 rounded-full text-sm {% if participante.estado_pago == 'Paid' %}bg-[#f1e9ea] text-[#191010]{% else %}bg-[#e92932] text-white{% endif %}">
                  {{ participante.estado_pago }}
                </span>
                </td>
                <td class="px-4 py-2 text-sm text-[#8b5b5c]">{{ participante.fecha_desembolso }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="px-4 py-4 text-center text-[#8b5b5c]">No hay participantes todavía.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- SECCIÓN NUEVA: Historial de Facturas del Usuario -->
      {% if user.is_authenticated and facturas_usuario %}
      <div class="px-4 py-6">
        <h2 class="text-[#1b0e0e] text-[22px] font-bold pb-3">Mis Facturas</h2>
        <div class="overflow-hidden rounded-xl border border-[#e3d4d4]">
          <table class="w-full">
            <thead>
              <tr class="bg-[#fbf9f9]">
                <th class="px-4 py-3 text-left text-sm font-medium">ID Factura</th>
                <th class="px-4 py-3 text-left text-sm font-medium">Monto</th>
                <th class="px-4 py-3 text-left text-sm font-medium">Fecha</th>
              </tr>
            </thead>
            <tbody>
              {% for factura in facturas_usuario %}
              <tr class="border-t border-[#e3d4d4]">
                <td class="px-4 py-2 text-sm text-[#191010]">{{ factura.id_unico }}</td>
                <td class="px-4 py-2 text-sm text-[#191010]">${{ factura.monto|floatformat:2 }}</td>
                <td class="px-4 py-2 text-sm text-[#8b5b5c]">{{ factura.fecha_emision|date:"F d, Y, h:i A" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- SECCIÓN NUEVA: Ganador -->
      {% if san.ganador %}
      <div class="px-4 py-6">
        <h2 class="text-[#1b0e0e] text-[22px] font-bold pb-3">Ganador</h2>
        <div class="p-4 rounded-lg bg-green-100 text-green-800">
          🎉 Felicidades a <strong>{{ san.ganador.get_full_name|default:san.ganador.username }}</strong> 🎉
        </div>
      </div>
      {% elif user == san.organizador and san.fecha_fin < now %} <div class="px-4 py-6">
        <form method="post" action="{% url 'seleccionar_ganador_san' san.id %}">
          {% csrf_token %}
          <button type="submit" class="rounded-lg bg-[#e92932] text-white px-5 py-3 font-bold hover:bg-[#c71f28]">
            Seleccionar Ganador
          </button>
        </form>
    </div>
    {% endif %}

    {% if user.is_authenticated %}
    <div class="flex px-4 py-3 justify-end gap-3">
      <a href="{% url 'generar_ticket_san' san.id %}"
        class="rounded-full h-10 px-4 bg-[#8b5b5c] text-white text-sm font-bold flex items-center">
        Generar Ticket
      </a>
      <a href="{% url 'my_contributions' %}"
        class="rounded-full h-10 px-4 bg-[#e8b5b7] text-[#191010] text-sm font-bold flex items-center">
        Ver Mis Aportes
      </a>
    </div>
    {% endif %}

  </div>
  </div>
</body>

</html>